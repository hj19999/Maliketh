function	script	getInstanceCooldown	{
	.@time = getarg(0);
	.@cooldown = .@time - gettimetick(2);
	if(.@cooldown < 0) .@cooldown = 0;
	return .@cooldown;
}

function	script	formatTime	{
	.@cooldown = getarg(0);
	.@d = .@cooldown / 86400;
 	.@cooldown -= .@d * 86400;
	.@d$ = .@d ? ""+.@d : "";
	.@h = .@cooldown / 3600;
	.@h$ = .@h > 10 ? ""+.@h : "0"+.@h;
	.@cooldown -= .@h * 3600;
	.@m = .@cooldown / 60;
	.@m$ = .@m > 10 ? ""+.@m : "0"+.@m;
	.@cooldown -= .@m * 60;
	.@s = .@cooldown;
	.@s$ = .@s > 10 ? ""+.@s : "0"+.@s;
	return (.@d ? .@d$  + "d " : "") +.@h$ + ":" + .@m$ + ":" + .@s$;

}

function	script	setInstanceCooldown	{
	.@id = getarg(0); // instance id
	.@cooldown = getarg(1);	//cd in seconds
	setd "instance_cd_"+.@id,gettimetick(2)+.@cooldown;
	return 1;
}

// cooldown & tickets available
function	script	getInstanceStatus	{
	.@id = getarg(0);
	.@mode = getarg(1,0);	// 0 = return 1 or 0, 1 = return exact time remaining, 2 = return #of tickets.
	.@cooldown = getInstanceCooldown(getd("instance_cd_"+.@id));
	switch(.@mode) {
		case 0:
		default:
			if(.@cooldown) return 1;
			return 0;
		case 1:
			if(!.@cooldown) return "";
            return formatTime(.@cooldown);
	}
}

function	script	instanceCooldownReset	{
	if(getarg(0)) {
		setd "instance_cd_"+getarg(0),0;
		return 1;
	}
	for(.@i = 1; .@i < 48; .@i++) {
		setd "instance_cd_"+.@i,0;
	}
	return 1;
}

// set/get instance tickets system
function	script	setInstanceTickets	{
	.@liveId = getarg(0); // id of LIVE instance
	.@tickets = getarg(1);
	setd "instance_tickets_"+.@liveId,.@tickets;
	return 1;
}
function	script	getInstanceTickets	{
	.@liveId = getarg(0);
	return getd("instance_tickets_"+.@liveId);
}

function	script	calculateCooldown	{
	.@cdInSeconds = getarg(0);
	.@d = .@cdInSeconds / 86400 - 1; //cooldown in days
	.@ttmidnight = 86400 - gettimetick(1);
    if(.@d < 1) 
		// cooldown ends in the same day
		return .@ttmidnight > .@cdInSeconds ? .@cdInSeconds : .@ttmidnight;
    return .@ttmidnight + .@d * 86400;
}

function	script	instanceDialoge	{
	.@name$ = getarg(0);
	.@tickets = getarg(1);
	.@cooldown = calculateCooldown(getarg(2));
	.@quests$ = getarg(3);
	.@minparty = getarg(4);	
	.@minlevel = getarg(5);
	.@maxlevel = getarg(6);
	.@party_id = getcharid(1);
	if(getInstanceStatus(instance_info(.@name$,IIT_ID),1) == "") {
		if(!instance_check_party(.@party_id,.@minparty,.@minlevel,.@maxlevel)) {
			mes "- ·«  ” Ê›Ì „Ã„Ê⁄ ﬂ -";
			mes "- «·‘—Êÿ ·œŒÊ· Â–« «·≈‰” «‰” -";
			next;
			mes "«·„” ÊÏ «·«œ‰Ï «·„ÿ·Ê»: "+.@minlevel+" - "+.@maxlevel;
			mes "⁄œœ «·√⁄÷«¡ «·«œ‰Ï «·„ÿ·Ê» ··œŒÊ·: "+.@minparty;
			close;
		}
		if (getcharid(0) == getpartyleader(.@party_id,2))
			.@menu$ = "› Õ »Ê«»… «·≈‰” «‰”";
		switch(select(.@menu$,"œŒÊ· «·≈‰” «‰”:≈·€«¡")) {
			case 3:
				close;
			case 2:
				switch(instance_enter(.@name$)) {
					case IE_OTHER:
						mes "- ·ﬁœ ÕœÀ Œÿ√ „ÃÂÊ· -";
						mes "- Ì—ÃÏ «· Ê«’· „⁄ ›—Ìﬁ «·≈œ«—… -";
						close;
					case IE_NOINSTANCE:
						mes "- Ì—ÃÏ › Õ »Ê«»… «·≈‰” «‰” -";
						mes "- «Ê·« ﬁ»· „Õ«Ê·… «·œŒÊ· -";
						close;
					case IE_NOMEMBER:
						mes "- √‰  ·”  ›Ì „Ã„Ê⁄… -";
						close;
					case IE_OK:
						setInstanceTickets(instance_id(IM_PARTY),.@tickets);
						setInstanceCooldown(instance_info(.@name$,IIT_ID),.@cooldown);
						explode(.@questlist$,.@quests$,"|");
						for(.@i = 0; .@i < getarraysize(.@questlist$);.@i++) {
							if(isbegin_quest(atoi(.@questlist$[.@i])) != 1)
								setquest atoi(.@questlist$[.@i]);
						}
						mapannounce strcharinfo(3), "" + strcharinfo(0) + " of the party, " + getpartyname(.@party_id) + ", is entering "+.@name$,bc_map,"0x00FF99";
						end;
				}
			case 1:
				switch(instance_create(.@name$)) {
					case -3:
						dispbottom "Â–« «·≈‰” «‰” „› ÊÕÒ »«·›⁄·.",0xFFFFFF;
						close;
					case -4:
					case -2:
					case -1:
						mes "Party Name: " + getpartyname( getcharid(1) );
						mes "Party Leader: " + strcharinfo(0);
						mes "^0000ff" + .@name$ + "^000000 - time gap generation failed.";
						close;
					}
					mes "·ﬁœ  „ › Õ »Ê«»… «·≈‰” «‰” »‰Ã«Õ.";
					close;
				}
		}
		if(instance_live_info(ILI_NAME,instance_id(IM_PARTY)) == .@name$) {
			.@remainingTickets = getInstanceTickets(instance_id(IM_PARTY));
			if(!.@remainingTickets) {
				mes "- ·« Ì„ﬂ‰ﬂ ≈⁄«œ… œŒÊ· Â–« «·œÂ·Ì“ -";
				mes "- „—¯… √Œ—Ï. -";
				close;
			}
			mes "- ⁄œœ «· –«ﬂ— «·„ »ﬁÌ… ·œÌﬂ ÂÌ: -";
			mes "- ^0000ff"+.@remainingTickets+"^000000 -";
			mes "- Â·  —Ìœ «·œŒÊ· „Ãœœ«ø -";
			if(select("‰⁄„:ﬂ·¯«") -1) close;
			setInstanceTickets(instance_id(IM_PARTY),.@remainingTickets - 1);
			instance_enter(.@name$);
			close;
		}
		mes "- ·« Ì„ﬂ‰ﬂ œŒÊ· Â–« «·≈‰” «‰” -";
		mes "- »⁄œ, ÌÃ» ⁄·Ìﬂ «·«‰ Ÿ«—: -";
		mes "- ^0000ff"+getInstanceStatus(instance_info(.@name$,IIT_ID),1)+" ^000000-";
		close;
}

-	script	instance_manager	-1,{
OnInit:
	bindatcmd("cooldown",strnpcinfo(3)+"::OnCommand",0,99);
    bindatcmd("reset", strnpcinfo(3)+"::OnResetCommand", 99, 99);
	end;

OnResetCommand:
    instanceCooldownReset();
    end;

OnCommand:
 	setarray .@instances$[1],"Charleston in Distress","Endless Tower","Sealed Catacomb","Orc's Memory","Nidhoggur's Nest","Mistwood Maze","Culvert","Octopus Cave","Bangungot Hospital 2F","Buwaya Cave","Bakonawa Lake","Wolfchev's Laboratory","Old Glast Heim","Eclage Interior","Sara's Memories","Geffen Magic Tournament","Horror Toy Factory","Faceworm's Nest","Ghost Palace","Devil's Tower","Assault on the Airship","Fenrir and Sarah","Nightmarish Jitterbug","Isle of Bios","Morse's Cave","Central Laboratory","Last room","Ritual of Blessing","Room of Consciousness","Sky Fortress Invasion","Heart Hunter War Base 1","Heart Hunter War Base 2","Werner Laboratory central room#1","Werner Laboratory central room#2";
	setarray .@alter$[0],"Heart Hunter War Base 1","","Werner Laboratory central room#1","","Werner Laboratory central room#1","Werner's Lab";
	for(.@i = 1; .@i < getarraysize(.@instances$); .@i++) {
		// dispbottom .@instances$[.@i],0x00FF00;
		.@name$ = .@instances$[.@i];
		if(inarray(.@alter$,.@instances$[.@i]) != -1) .@name$ = .@alter$[inarray(.@alter$,.@instances$[.@i])+1];
		if(.@name$ == "") continue;
		.@cooldown$ = getInstanceStatus(instance_info(.@instances$[.@i],IIT_ID),1);
		// .@color = .@cooldown$ == "" ? 16711680 : 65280; 
		if(.@cooldown$ == "") .@cooldown$ = "Available";
		.@string$ = .@name$+" : "+.@cooldown$;
		if(.@cooldown$ == "Available") dispbottom .@string$,65280;
		else dispbottom .@string$,16711680;
	}
	dispbottom "Ì‰ ÂÌ  √ŒÌ— œŒÊ· «·≈‰” «‰” ›Ì  „«„ «·”«⁄… 12:00 ·Ì·« » ÊﬁÌ  «·”⁄ÊœÌ….",65280;
	end;
}
